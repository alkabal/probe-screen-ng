o<psng_tool_diameter> sub
o<psng_hook> call [2]

o90 if [#<_hal[probe.setterheight]> EQ 0 OR #<_hal[probe.setterheight]> LT 0]
    (MSG,TOOLSETTER HEIGHT NOT CONFIGURED)
o90 return [-1] ; indicate setterheight <= 0
o90 endif

o100 if [#<_hal[probe.ps_searchvel]> LE 0]
o100 return [-2] ; indicate searchvel <= 0
o100 endif

o200 if [#<_hal[probe.ps_probevel]> LE 0]
o200 return [-3] ; indicate probevel <= 0
o200 endif

o300 if [#5400 EQ 0]
     (MSG,MEASURE TOOL DIAMETER AND LENGHT NOT ALLOWED WITH TOOL 0)
     G4P0.2
     M2
o300 endif

o<psng_goto_toolsensor> call                                                ; with G90 inside


(cancel all Z offsets)(+ cutter compensation for diameter measurement)
G92.1                                                                       ; use pause can be better than reset ???
G49 ;G40                                                                     

 o400  if [#<_coord_system> EQ 540]
       #<backup_offset> = #5223
 o400  elseif [#<_coord_system> EQ 550]
       #<backup_offset> = #5243
 o400  elseif [#<_coord_system> EQ 560]
       #<backup_offset> = #5263
 o400  elseif [#<_coord_system> EQ 570]
       #<backup_offset> = #5283
 o400  elseif [#<_coord_system> EQ 580]
       #<backup_offset> = #5303
 o400  elseif [#<_coord_system> EQ 590]
       #<backup_offset> = #5323
 o400  elseif [#<_coord_system> EQ 591]
       #<backup_offset> = #5343
 o400  elseif [#<_coord_system> EQ 592]
       #<backup_offset> = #5363
 o400  elseif [#<_coord_system> EQ 593]
       #<backup_offset> = #5383
 o400 endif
      (DEBUG,hookbackoffset #<backup_offset>)

;o<psng_backup_offset> call                                                 ; does not work for restoring value
G10 L2 P0 Z0                                                                ; reset G54 offset for correct tool measurement

o<psng_start_setter_probing> call

G91
G1    Z[#<_hal[probe.ps_z_clearance]>*0.7] F#<_hal[probe.ps_searchvel]>    ; macro use ps_z_clearance*0.7 for allow tool to be en contact with setter pad for diam measure
G90

#<touch_result> = #5063
;#<backup_offset> = #1                                                     ; does not work for restoring value
    (DEBUG,touch #<touch_result> backoffset #<backup_offset>)
G10 L1 P#5400 Z[#<touch_result> - #<_hal[probe.setterheight]>]
G10 L2 P0     Z#<backup_offset>

; next for x+ x- y+ y- done inside python code

o<psng_hook_end> call [2]                          ; workaround not wanted here need to be inside python code after other movement but without this i have some issue after Z the program fail
o<psng_tool_diameter> endsub
M2

