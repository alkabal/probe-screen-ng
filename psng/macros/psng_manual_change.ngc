; manual toolchange with automatic tool length probe

o<psng_manual_change> sub

;(DEBUG,in change tool_in_spindle=#<tool_in_spindle> current_pocket=#<current_pocket>)
;(DEBUG,selected_tool=#<selected_tool> selected_pocket=#<selected_pocket>)

;otherwise after the M6 this information is gone! but it seem to be unused
#<tool> = #<selected_tool>
#<pocket> = #<selected_pocket>

; we must execute this only in the milltask interpreter
; or preview will break, so test for '#<_task>' which is 1 for
; the milltask interpreter and 0 in the UI's
o10 if [#<_task> EQ 0]
        (DEBUG,Task ist Null)
o10     return [999]
o10 endif

o<psng_goto_changepos> call
o<clear-axis-notif> call

G49  ; cancel tool offset

o100 if [#<_hal[probe.use_toolmeasurement]> EQ 0 OR #<_selected_tool> EQ 0]
  o101 if [#<_ini[PROBE_SCREEN]TOOLCHANGE_POPUP_STYLE> EQ 0]
     o110 if [#<_selected_tool> EQ 0]
         (MSG,PLEASE REMOVE TOOL)
         (MSG,NEED TO UNPAUSE OR ABORT)
         M0
         o<clear-axis-notif> call
     o110 elseif [#<_current_tool> EQ #<_selected_tool>]
          (MSG,SAME TOOL AS ACTUAL ASKED AND VALIDATED AUTOMATICALLY)
     o110 elseif [#<_selected_tool> GT 0]
          (DEBUG,PLEASE CHANGE TO TOOL #<_selected_tool>)
          (MSG,NEED TO UNPAUSE OR ABORT)
          M0
          o<clear-axis-notif> call
     o110 else
          (DEBUG,UNKNOW ERROR OCCURED FOR TOOLCHANGE WITHOUT AUTOlength)
     o110 return [-9]
     o110 endif
  o101 elseif [#<_current_tool> EQ #<_selected_tool> AND #<_current_tool> GT 0]
       (MSG,SAME TOOL AS ACTUAL ASKED AND VALIDATED AUTOMATICALLY)
  o101 endif
     M6         ; using the code being remapped here means 'use builtin behaviour' used here for M6T0
     G43
o100 return [3] ; indicate no tool measurement possible with tool 0 or no tool measurement configured

o100 else
     o130 if [#<_hal[probe.ps_searchvel]> LE 0]
          (MSG,SEARCH VELOCITY NOT CONFIGURED)
          (MSG,TOOLCHANGE CANCELED)
     o130 return [-1] ; indicate searchvel <= 0
     o130 endif

     o140 if [#<_hal[probe.ps_probevel]> LE 0]
          (MSG,PROBE VELOCITY NOT CONFIGURED)
          (MSG,TOOLCHANGE CANCELED)
     o140 return [-2] ; indicate probevel <= 0
     o140 endif

     o150 if [#<_hal[probe.setterheight]> LE 0]
          (MSG,TOOLSETTER HEIGHT NOT CONFIGURED)
          (MSG,TOOLCHANGE CANCELED)
     o150 return [-3]
     o150 endif

     o<psng_hook> call [1]                                   ; User macro like pre safe test or probe and setter management etc

     o160 if [#<_value> LT 0]
          (DEBUG, PSNG hook indicated a failure: #<_value>)
     o160 return [-4]
     o160 endif
     
  o102 if [#<_ini[PROBE_SCREEN]TOOLCHANGE_POPUP_STYLE> EQ 0]
     o170 if [#<_current_tool> EQ #<_selected_tool>]
          (MSG,SAME TOOL AS ACTUAL SO MEASUREMENT START AUTOMATICALLY)
          (MSG,NEED TO UNPAUSE OR ABORT)
          M0
          o<clear-axis-notif> call
     o170 endif

     o200 if [#<_current_tool> NE #<_selected_tool>]
          (DEBUG,PLEASE CHANGE TO TOOL #<_selected_tool>)
          (MSG,NEED TO UNPAUSE OR ABORT)
          M0
          o<clear-axis-notif> call
     o200 endif
  o102 elseif [#<_current_tool> EQ #<_selected_tool> AND #<_current_tool> GT 0]
       (MSG,SAME TOOL AS ACTUAL ASKED AND VALIDATED AUTOMATICALLY)
       (MSG,NEED TO UNPAUSE OR ABORT)
       M0                                                                 ; prevent starting move without any popup confirmation !!!!
  o102 endif
o100 endif

M6   ; using the code being remapped here means 'use builtin behaviour' used here for M6Tx

o300 if [#<_hal[motion.probe-input]> EQ 1]                                ; DON'T KNOW WHY BUT IF TRY TO DO THIS BEFORE IN THIS CODE THE M64P1 Seem to be ignored and also pause in hook is ignored
     o<psng_hook_end> call
    (MSG,!!! PROBE OR SETTER ALREADY TRIGGERED BEFORE STARTING AUTOlength !!!)
o300 return [-5]
o300 endif

o<psng_goto_toolsensor> call                                                ; with G90 inside

; cancel G5x offset
o<psng_backup_offset> call
G10 L2 P0 Z0                                                                ; reset G54 offset for correct tool measurement

o<psng_start_setter_probing> call

o500 if [#5070 EQ 0]
     o<psng_hook_end> call
o500 return [-6] ; indicate probe contact failure to epilog
o500 endif

#<touch_result> = [#5063 - #<_hal[probe.setterheight]>]
(print, probe Z=#<touch_result>)

G10 L1 P#<_current_tool> Z[#<touch_result>]
G10 L2 P0     Z#<_backup_offset>
;G10 L2 P0 Z#<_hal[probe.blockheight]>                                       ; apply G54 offset again after correct tool measurement  ; need to think about use save restore like tool length

(back to Z max position only)
G53 G0 Z[#<_ini[AXIS_Z]MAX_LIMIT>+#<_ini[CHANGE_POSITION]Z_SAFE_TRAVEL_OFFSET>]
G43

;(DEBUG,Zvalue:#<touch_result> Setter;#<_hal[probe.setterheight]>, Block:#<_hal[probe.blockheight]>)
(MSG,TODO what about G43 G41 G42 can be saved at macro start and restored at end : see "lathemacro")

o<psng_hook_end> call

; signal success be returning a value > 0:
o<psng_manual_change> endsub [1]
M2

